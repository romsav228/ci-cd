name: Full CI/CD Pipeline

on:
  push:
    branches:
      - main

env:
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: ~/.cache/pip

jobs:
  unit-test:
    name: 游빍 Unit Test
    runs-on: ubuntu-latest

    steps:
      - name: 游닌 Checkout code
        uses: actions/checkout@v3

      - name: 游냀 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 游 Cache pip packages
        uses: actions/cache@v3
        id: pip-cache
        with:
          path: |
            ~/.cache/pip
            ~/.local/lib/python${{ env.PYTHON_VERSION }}/site-packages
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 游 Cache pytest
        uses: actions/cache@v3
        with:
          path: ~/.cache/pytest
          key: ${{ runner.os }}-pytest-${{ hashFiles('**/*.py') }}
          restore-keys: |
            ${{ runner.os }}-pytest-

      - name: 游닍 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 游빍 Run unit tests
        env:
          DATABASE_URL: sqlite+aiosqlite:///./test_auth.db
        run: pytest tests/test_unit.py

  staging:
    name: 游 Deploy to Staging
    runs-on: ubuntu-latest
    needs: unit-test

    steps:
      - name: 游닌 Checkout code
        uses: actions/checkout@v3

      - name: 游냀 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 游 Cache pip packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.local/lib/python${{ env.PYTHON_VERSION }}/site-packages
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 游닍 Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: 游 Run staging app
        env:
          DATABASE_URL: sqlite+aiosqlite:///./staging_auth.db
        run: |
          python -m uvicorn main:app --host 0.0.0.0 --port 8000 &
          echo "Staging app started on port 8000"
      

  integration-test:
    name: 游빍 Integration Test
    runs-on: ubuntu-latest
    needs: staging

    steps:
      - name: 游닌 Checkout code
        uses: actions/checkout@v3

      - name: 游냀 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 游 Cache pip packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.local/lib/python${{ env.PYTHON_VERSION }}/site-packages
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 游닍 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 游빍 Run integration tests
        env:
          DATABASE_URL: sqlite+aiosqlite:///./integration_test_auth.db
        run: pytest tests/test_integration.py -v

  production:
    name: 游 Deploy to Production
    runs-on: ubuntu-latest
    needs: integration-test

    steps:
      - name: 游닌 Checkout code
        uses: actions/checkout@v3

      - name: 游냀 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 游 Cache pip packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.local/lib/python${{ env.PYTHON_VERSION }}/site-packages
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 游닍 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 游 Run production app
        env:
          DATABASE_URL: sqlite+aiosqlite:///./prod_auth.db
          JWT_ACCESS_SECRET: ${{ secrets.JWT_ACCESS_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
        run: |
          python -m uvicorn main:app --host 0.0.0.0 --port 8000 &
          echo "Production app started on port 8000"
